<!DOCTYPE html>
<html>
<head>
<title>TM1 - Number of Cubes</title>

<style type="text/css">
iframe
{
	position: absolute;
	left : 50%;
	top : 50%;
	margin-left: -300px;
	margin-top: -250px;
	width: 600px;
	height: 500px;
}
</style>

<script type="text/javascript" src=""https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js""></script>

</head>

<script type="text/javascript">
function init()
{

	"use strict";

	/*
	 * Compensate for missing functions in various browsers/browser versions
	 */

	if ( !String.prototype.startsWith )
	{
		Object.defineProperty( String.prototype, "startsWith", { value: function startsWith( _substr/* _offset*/ )
		{
			var offset = arguments[1] >>> 0;
			return this.lastIndexOf( _substr, offset ) === offset;
		} } );
	}

	/*
	 * REST request and CAM authentication helpers
	 */

	var loginFrame = null;
	
	function showCAMLogin( _urlCognosGateway, _onClose )
	{
		function onClose()
		{
			// This callback is invoked from the iframe. wait a cycle before killing what calls it.
			setTimeout( function()
			{
				// Remove handlers
				delete window.ccModalCallBack;
				delete window.closeErrorPage;

				// Remove iframe and closure reference
				loginFrame.parentNode.removeChild( loginFrame );
				loginFrame = null;
				
				// Call any on close event if one specified.
				if ( _onClose )
					_onClose();

			}, 1 );
		}

		if ( loginFrame !== null )
			return;

		// Create a new iframe in which we'll show the CAM login page	
		loginFrame = document.body.appendChild( document.createElement( "iframe" ));

		// Ugly hack to prevent IE from asking to close the window
		try
		{
			Object.defineProperty( loginFrame.contentWindow, "close", { value: function() {} } );
		}
		catch( e )
		{
		}

		// Register handlers
		window.ccModalCallBack = window.closeErrorPage = onClose;

		// Show the CAM login page
		loginFrame.src = _urlCognosGateway + "?b_action=xts.run&m=portal/close.xts&h_CAM_action=logon";
	}

	function getCAMPassport()
	{
		var match = document.cookie.match( /(^|;\s*)cam_passport=([^$;]*)/ );
		return match && match[2];
	}

	var authorizationCAM = null;
	
	function authenticateUsingCAM( _urlCognosGateway, _onSuccess, _onFailure )
	{
		var camPassport = getCAMPassport();
		
		// Do we happen to have a CAM passport already?
		if ( camPassport )
		{
			// We do! Were we trying to reuse it already?
			if ( !authorizationCAM )
			{
				// Apparently not, try reusing it first.
				authorizationCAM = 'CAMPassport ' + camPassport;
				
				// Call any on complete event if one specified.
				if ( _onSuccess )
					_onSuccess();
				return;
			}
			else
			{
				// Existing CAM passport is apparently not, or no longer, valid for login with TM1
				authorizationCAM = null;
			}
		}
		
		// Show a CAM login page
		showCAMLogin( _urlCognosGateway, function()
		{
			// Was the logon successful?
			camPassport = getCAMPassport();
			if ( camPassport )
			{
				// Yes, set the authentication header to be used with the next request accordingly
				authorizationCAM = 'CAMPassport ' + camPassport;

				// Call any on complete event if one specified.
				if ( _onSuccess )
					_onSuccess();
			}
			else
			{
				// Failed to authenticate.
				if ( _onFailure )
					_onFailure();
			}
		} );
	}

	function handleUnauthorizedCAM( _response, _onSuccess, _onFailure )
	{
		var bHandled = false;
		
		// Handle the 401 Unauthorized response for CAMPassport
		if ( _response.status === 401 )
		{
			var authHeader = _response.getResponseHeader( "WWW-Authenticate" );
			if ( authHeader )
			{
				authHeader.split( /\s*,\s*/ ).some( function( _entry )
				{
					if ( _entry.startsWith( "CAMPassport" ))
					{
						authenticateUsingCAM( _entry.substr( 12 ), _onSuccess, _onFailure );
						bHandled = true;
						return true;
					}
					return false;
				} );
			}
		}
		return bHandled;
	}

	function executeRESTRequest( _url, _accept, _onSuccess, _onError )
	{
		// Build set of headers to be passed along with the request
		var headers = { };
		if ( _accept )
			headers['Accept'] = _accept;
		if ( authorizationCAM )
			headers['Authorization'] = authorizationCAM;

		// Execute the request
		$.ajax(
		{
			async: true,
			headers: headers,
			url: _url,
			xhrFields: { withCredentials: true },
			success: function( _data )
			{
				authorizationCAM = null;
				if ( _onSuccess )
					_onSuccess( _data );
			},
			error: function( _response ) 
			{
				if ( _onError )
					_onError( _response );
			}
		} );
	}

	/*
	 * THE Sample - retrieving the number of cubes
	 */
	
	var serviceRootURL = "/tm1/";
	
	function numberOfCubes()
	{
		executeRESTRequest( 
			serviceRootURL + "Cubes/$count", 
			"*/*", 
			function( _numberOfCubes )
			{
				// Set the content of the window to the response of the REST request, just a number in this case...
				document.getElementById( "numberOfCubes" ).value = _numberOfCubes;
			},
			function( _response )
			{
				// Check if the error response is a 401 Unauthorized and if so handle CAM authentication
				// NOTE: Standard TM1 authentication and Windows Integrated Authentication (on a Windows OS)
				// are supported natively by the browser and will never get here to begin with.
				if ( !handleUnauthorizedCAM( 
					_response, 
					function()
					{
						// After successful authentication retry to retrieve the number of cubes immediately!
						numberOfCubes();
					},
					function() 
					{
						alert( "Authentication failed!" );
					}
				))
				{
					alert( "Retrieving number of cubes failed with status: " + _response.status + " " + _response.statusText );
				}
			} 
		);
	}

	// Kick of the retrieval of the number of cubes
	numberOfCubes();
};

</script>

<body onload="init();">

Number of Cubes: <input type="text" id="numberOfCubes" value="">

</body>

</html>